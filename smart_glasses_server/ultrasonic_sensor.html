<!DOCTYPE html>
<html>
<head>
    <title>Ultrasonic Distance Sensor Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: rgba(255,255,255,0.95); 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            margin-top: 20px;
            backdrop-filter: blur(15px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 35px;
            padding: 25px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            color: white;
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.3);
        }
        
        .header h1 { 
            font-size: 2.8em; 
            margin-bottom: 12px; 
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header p { 
            font-size: 1.3em; 
            opacity: 0.95; 
            font-weight: 300;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .distance-display {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
        }
        
        .controls-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .section-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #f0f0f0;
            padding-bottom: 10px;
        }
        
        .distance-reading {
            font-size: 4em;
            font-weight: 700;
            margin: 20px 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .distance-zone {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: 600;
            margin: 15px 0;
            transition: all 0.3s ease;
        }
        
        .zone-very-close { 
            background: linear-gradient(135deg, #f44336, #ef5350); 
            color: white; 
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3); 
        }
        .zone-close { 
            background: linear-gradient(135deg, #ff9800, #ffa726); 
            color: white; 
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3); 
        }
        .zone-medium { 
            background: linear-gradient(135deg, #ffc107, #ffca28); 
            color: #333; 
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3); 
        }
        .zone-far { 
            background: linear-gradient(135deg, #8bc34a, #aed581); 
            color: white; 
            box-shadow: 0 4px 15px rgba(139, 195, 74, 0.3); 
        }
        .zone-very-far { 
            background: linear-gradient(135deg, #4caf50, #66bb6a); 
            color: white; 
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); 
        }
        
        .button { 
            padding: 14px 28px; 
            margin: 10px 8px; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .button:hover::before {
            left: 100%;
        }
        
        .stop { 
            background: linear-gradient(135deg, #f44336, #da190b); 
            color: white; 
        }
        .stop:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(244, 67, 54, 0.4); 
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin: 25px 0;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
        }
        
        .stat-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .stat-card h4 { 
            margin-bottom: 15px; 
            color: #666; 
            font-size: 1em; 
            text-transform: uppercase; 
            letter-spacing: 1.5px;
            font-weight: 600;
        }
        
        .stat-card .stat-value { 
            font-size: 2.8em; 
            font-weight: 700; 
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-card .stat-label { 
            color: #999; 
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .distance-card .stat-value { background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .measurement-card .stat-value { background: linear-gradient(135deg, #f093fb, #f5576c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .quality-card .stat-value { background: linear-gradient(135deg, #4facfe, #00f2fe); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .range-card .stat-value { background: linear-gradient(135deg, #43e97b, #38f9d7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .status { 
            padding: 18px 20px; 
            margin: 18px 0; 
            border-radius: 12px; 
            font-weight: 600;
            border-left: 5px solid;
            font-size: 1.05em;
        }
        .status.error { 
            background: linear-gradient(135deg, #ffebee, #fce4ec); 
            color: #c62828; 
            border-color: #f44336; 
        }
        .status.warning { 
            background: linear-gradient(135deg, #fff3e0, #fef7e0); 
            color: #ef6c00; 
            border-color: #ff9800; 
        }
        .status.success { 
            background: linear-gradient(135deg, #e8f5e8, #f1f8e9); 
            color: #2e7d32; 
            border-color: #4caf50; 
        }
        
        .results-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin-top: 25px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .measurement-log { 
            margin: 18px 0; 
            padding: 18px 20px; 
            border-radius: 12px;
            border-left: 5px solid;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .measurement-log:hover { 
            transform: translateX(8px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .zone-very-close-log { 
            background: linear-gradient(135deg, #ffebee, #fce4ec); 
            border-color: #f44336;
            color: #c62828;
        }
        .zone-close-log { 
            background: linear-gradient(135deg, #fff3e0, #fef7e0); 
            border-color: #ff9800;
            color: #ef6c00;
        }
        .zone-medium-log { 
            background: linear-gradient(135deg, #fffde7, #f9fbe7); 
            border-color: #ffc107;
            color: #f57c00;
        }
        .zone-far-log { 
            background: linear-gradient(135deg, #f1f8e9, #e8f5e8); 
            border-color: #8bc34a;
            color: #558b2f;
        }
        .zone-very-far-log { 
            background: linear-gradient(135deg, #e8f5e8, #f1f8e9); 
            border-color: #4caf50;
            color: #2e7d32;
        }
        
        .log-header {
            font-weight: 600;
            font-size: 1.15em;
            margin-bottom: 10px;
        }
        
        .log-details {
            font-size: 0.95em;
            opacity: 0.85;
            font-weight: 500;
        }
        
        .quality-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .quality-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 5px;
            transition: width 0.6s ease;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 8px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .tab {
            flex: 1;
            padding: 18px 25px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1.05em;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        
        .tab:not(.active):hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 20px;
            margin: 25px 0;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: #666;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 20px;
            border: 2px dashed #dee2e6;
        }
        
        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #495057;
        }
        
        .empty-state p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .report-section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin: 25px 0;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #f0f0f0;
        }
        
        .report-header h2 {
            font-size: 1.8em;
            font-weight: 700;
            color: #333;
        }
        
        .date-picker {
            padding: 12px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            transition: border-color 0.3s ease;
        }
        
        .date-picker:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .insights-list {
            list-style: none;
            padding: 0;
        }
        
        .insights-list li {
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .insights-list li:hover {
            background: #f8f9fa;
            padding-left: 15px;
            border-radius: 8px;
        }
        
        .insights-list li:last-child {
            border-bottom: none;
        }

        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 18px 20px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-left: 5px solid;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-color: #4caf50;
            background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
        }

        .toast.error {
            border-color: #f44336;
            background: linear-gradient(135deg, #ffebee, #fce4ec);
        }

        .toast.warning {
            border-color: #ff9800;
            background: linear-gradient(135deg, #fff3e0, #fef7e0);
        }

        .toast.info {
            border-color: #2196f3;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }

        .toast-header {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            padding: 0;
            margin-left: 15px;
        }

        .toast-message {
            font-size: 0.95em;
            line-height: 1.4;
            color: #555;
        }

        .toast::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0;
            background: rgba(255,255,255,0.3);
            animation: toastProgress 4s linear;
        }

        @keyframes toastProgress {
            to { width: 100%; }
        }

        /* Enhanced Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #f0f0f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .analytics-grid {
                grid-template-columns: repeat(auto-fit, minWidth(250px, 1fr));
            }
            
            .container {
                margin: 10px;
                padding: 20px;
            }

            .toast-container {
                left: 20px;
                right: 20px;
                max-width: none;
            }

            .toast {
                transform: translateY(-100px);
            }

            .toast.show {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <div class="container">
        <div class="header">
            <h1>📏 Distance Sensor Dashboard</h1>
            <p>Real-time ultrasonic distance measurements with analytics</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab(event, 'live')">📡 Live Measurements</div>
            <div class="tab" onclick="switchTab(event, 'analytics')">📊 Analytics</div>
            <div class="tab" onclick="switchTab(event, 'reports')">📋 Reports</div>
        </div>
        
        <div id="live-tab" class="tab-content active">
            <div class="dashboard-grid">
                <div class="distance-display">
                    <h3 class="section-title">📏 Current Distance</h3>
                    <div class="distance-reading" id="distanceReading">-- cm</div>
                    <div class="distance-zone" id="distanceZone">Connecting...</div>
                    <div id="qualityDisplay" style="margin-top: 20px; font-size: 1.1em; font-weight: 600; color: #666;">
                        Quality: <span id="qualityScore">--</span>%
                    </div>
                    <div class="quality-bar">
                        <div class="quality-fill" id="qualityBar" style="width: 0%;"></div>
                    </div>
                </div>
                
                <div class="controls-section">
                    <h3 class="section-title">🎮 Controls</h3>
                    <button class="button stop" onclick="stopSensor()">⏹️ Stop Sensor</button>
                    
                    <h3 class="section-title" style="margin-top: 25px;">📡 System Status</h3>
                    <div id="status" class="status">Connecting to sensor...</div>
                    
                    <h3 class="section-title" style="margin-top: 25px;">🔍 Current Reading</h3>
                    <div id="currentReading"></div>
                </div>
            </div>
            
            <div class="results-section">
                <h3 class="section-title">📝 Recent Measurements</h3>
                <div id="measurements"></div>
            </div>
        </div>
        
        <div id="analytics-tab" class="tab-content">
            <div class="analytics-grid">
                <div class="stat-card distance-card">
                    <h4>Average Distance</h4>
                    <div class="stat-value" id="avgDistance">0 cm</div>
                    <div class="stat-label">Mean Reading</div>
                </div>
                <div class="stat-card measurement-card">
                    <h4>Total Measurements</h4>
                    <div class="stat-value" id="totalMeasurements">0</div>
                    <div class="stat-label">Sensor Readings</div>
                </div>
                <div class="stat-card range-card">
                    <h4>Distance Range</h4>
                    <div class="stat-value" id="distanceRange">0 cm</div>
                    <div class="stat-label">Min - Max</div>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="section-title">📈 Zone Distribution</h3>
                <div id="zoneChart"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="section-title">⏰ 24-Hour Activity</h3>
                <div id="hourlyChart"></div>
            </div>
        </div>
        
        <div id="reports-tab" class="tab-content">
            <div class="report-section">
                <div class="report-header">
                    <h2>📋 Daily Analysis Report</h2>
                    <div>
                        <input type="date" id="reportDate" class="date-picker" onchange="loadDailyReport()" />
                    </div>
                </div>
                
                <div id="reportContent"></div>
            </div>
            
            <div class="report-section">
                <h3 class="section-title">📊 Measurement Logs</h3>
                <div id="measurementLogs"></div>
            </div>
        </div>
    </div>

    <script>
        let sensorActive = false;
        let measurementInterval;
        let currentDistance = 0.0;
        let currentStats = {};

        function showToast(message, type = 'info', title = '', duration = 4000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
        
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
        
            const titles = {
                success: title || 'Success',
                error: title || 'Error',
                warning: title || 'Warning', 
                info: title || 'Information'
            };
        
            toast.innerHTML = `
                <div class="toast-header">
                    <span>${icons[type]} ${titles[type]}</span>
                    <button class="toast-close" onclick="closeToast(this)">&times;</button>
                </div>
                <div class="toast-message">${message}</div>
            `;
        
            toastContainer.appendChild(toast);
        
            setTimeout(() => toast.classList.add('show'), 100);
        
            setTimeout(() => {
                if (toast.parentNode) {
                    closeToast(toast.querySelector('.toast-close'));
                }
            }, duration);
        }

        function closeToast(button) {
            const toast = button.closest('.toast');
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 400);
        }

        function switchTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            const tabContent = document.getElementById(tabName + '-tab');
            if (tabContent) {
                tabContent.classList.add('active');
            }

            if (event && event.target) {
                event.target.classList.add('active');
            }

            switch(tabName) {
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'reports':
                    setDefaultReportDate();
                    loadDailyReport();
                    break;
            }
        }

        function stopSensor() {
            sensorActive = false;
            document.getElementById('status').innerHTML = '<span class="loading-spinner"></span>Stopping sensor...';
            
            if (measurementInterval) {
                clearInterval(measurementInterval);
            }
            
            fetch('/api/sensor/stop', { method: 'POST' })
                .then(() => {
                    document.getElementById('status').innerHTML = '⏸️ Sensor Stopped';
                    document.getElementById('status').className = 'status warning';
                    showToast('Sensor stopped successfully', 'info', 'Sensor Stopped');
                })
                .catch(() => {
                    document.getElementById('status').innerHTML = '⏸️ Sensor Stopped';
                    document.getElementById('status').className = 'status warning';
                    showToast('Sensor stopped (connection lost)', 'warning', 'Sensor Stopped');
                });
        }

        function getCurrentDistance() {
            if (!sensorActive) return;
            
            fetch('/api/distance/current')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.distance !== undefined) {
                        updateDistanceDisplay(data);
                        displayMeasurement(data);
                        updateCurrentReading(data);
                    } else if (data.error) {
                        displayError(data.error);
                    }
                })
                .catch(err => {
                    console.error('Distance reading error:', err);
                    displayError(`Connection error: ${err.message}`);
                });
        }

        function updateDistanceDisplay(data) {
            const distanceReading = document.getElementById('distanceReading');
            const distanceZone = document.getElementById('distanceZone');
            const qualityScore = document.getElementById('qualityScore');
            const qualityBar = document.getElementById('qualityBar');
            
            if (distanceReading) {
                distanceReading.textContent = data.distance.toFixed(1) + ' cm';
            }
            
            if (distanceZone) {
                distanceZone.textContent = formatZone(data.zone);
                distanceZone.className = 'distance-zone zone-' + data.zone;
            }
            
            if (qualityScore) {
                qualityScore.textContent = (data.quality_score * 100).toFixed(1);
            }
            
            if (qualityBar) {
                qualityBar.style.width = (data.quality_score * 100) + '%';
            }
            
            currentDistance = data.distance;
        }

        function updateCurrentReading(data) {
            const currentReading = document.getElementById('currentReading');
            if (!currentReading) return;
            
            currentReading.innerHTML = `
                <div style="padding: 18px; background: linear-gradient(135deg, #e8f5e8, #f1f8e9); border-radius: 12px; margin-top: 18px; border-left: 4px solid #4caf50;">
                    <div style="font-weight: 700; color: #2e7d32; font-size: 1.2em;">
                        📏 ${data.distance.toFixed(1)} cm
                        <span class="distance-zone zone-${data.zone}" style="margin-left: 10px; font-size: 0.8em; padding: 6px 12px;">
                            ${formatZone(data.zone)}
                        </span>
                    </div>
                    <div style="font-size: 0.95em; margin-top: 10px; color: #4caf50; font-weight: 500;">
                        Quality: ${(data.quality_score * 100).toFixed(1)}% • 
                        Zone: ${formatZone(data.zone)} • 
                        Time: ${new Date(data.timestamp).toLocaleTimeString()}
                    </div>
                    <div class="quality-bar">
                        <div class="quality-fill" style="width: ${(data.quality_score * 100)}%;"></div>
                    </div>
                </div>
            `;
        }

        function displayMeasurement(data) {
            let measurementsDiv = document.getElementById('measurements');
            if (!measurementsDiv) return;
            
            let measurementClass = 'zone-' + data.zone + '-log';
            
            let measurementHtml = `
                <div class="measurement-log ${measurementClass}">
                    <div class="log-header">
                        ${new Date().toLocaleTimeString()} - ${data.distance.toFixed(1)} cm
                        <span class="distance-zone zone-${data.zone}" style="margin-left: 15px; font-size: 0.9em; padding: 6px 12px;">
                            ${formatZone(data.zone)}
                        </span>
                    </div>
                    <div class="log-details">
                        Quality: ${(data.quality_score * 100).toFixed(1)}% • 
                        Zone: ${formatZone(data.zone)} • 
                        Timestamp: ${new Date(data.timestamp).toLocaleString()}
                    </div>
                    <div class="quality-bar">
                        <div class="quality-fill" style="width: ${(data.quality_score * 100)}%;"></div>
                    </div>
                </div>
            `;
            
            measurementsDiv.innerHTML = measurementHtml + measurementsDiv.innerHTML;
          
            let measurements = measurementsDiv.children;
            while (measurements.length > 10) {
                measurementsDiv.removeChild(measurements[measurements.length - 1]);
            }
        }

        function displayError(errorMessage) {
            const currentReading = document.getElementById('currentReading');
            if (currentReading) {
                currentReading.innerHTML = `
                    <div style="padding: 18px; background: linear-gradient(135deg, #ffebee, #fce4ec); border-radius: 12px; margin-top: 18px; border-left: 4px solid #f44336;">
                        <div style="font-weight: 600; color: #c62828; font-size: 1.1em;">❌ ${errorMessage}</div>
                    </div>
                `;
            }
        }

        function loadAnalytics() {
            fetch('/api/analytics')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    currentStats = data;
                    updateAnalyticsDisplay(data);
                })
                .catch(err => {
                    console.error('Analytics error:', err);
                    showToast('Failed to load analytics data', 'error', 'Analytics Error');
                    
                    const analyticsElements = ['avgDistance', 'totalMeasurements', 'distanceRange'];
                    analyticsElements.forEach(elementId => {
                        const element = document.getElementById(elementId);
                        if (element) element.textContent = '0';
                    });
                });
        }

        function updateAnalyticsDisplay(data) {
            if (data && data.stats) {
                let stats = data.stats;
                
                const avgDistanceEl = document.getElementById('avgDistance');
                const totalMeasurementsEl = document.getElementById('totalMeasurements');
                const distanceRangeEl = document.getElementById('distanceRange');
                
                if (avgDistanceEl) avgDistanceEl.textContent = stats.avg_distance.toFixed(1) + ' cm';
                if (totalMeasurementsEl) totalMeasurementsEl.textContent = stats.total_measurements;
                
                if (distanceRangeEl) {
                    if (stats.min_distance === Infinity) {
                        distanceRangeEl.textContent = '0 cm';
                    } else {
                        distanceRangeEl.textContent = `${stats.min_distance.toFixed(1)} - ${stats.max_distance.toFixed(1)} cm`;
                    }
                }
            }
            
            if (data && data.zone_distribution) {
                updateZoneChart(data.zone_distribution);
            }
            
            if (data && data.hourly_distribution) {
                updateHourlyChart(data.hourly_distribution);
            }
        }

        function updateZoneChart(zoneData) {
            const chartDiv = document.getElementById('zoneChart');
            const total = Object.values(zoneData).reduce((a, b) => a + b, 0);
            
            if (total === 0) {
                chartDiv.innerHTML = `
                    <div class="empty-state">
                        <h3>📊 No Zone Data</h3>
                        <p>Zone distribution will appear here once measurements begin.</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: flex; flex-wrap: wrap; gap: 15px;">';
            
            Object.entries(zoneData).forEach(([zone, count]) => {
                const percentage = ((count / total) * 100).toFixed(1);
                html += `
                    <div class="distance-zone zone-${zone}" style="flex: 1; min-width: 140px; text-align: center; padding: 15px;">
                        ${formatZone(zone)}<br>
                        <strong>${count} (${percentage}%)</strong>
                    </div>
                `;
            });
            
            html += '</div>';
            chartDiv.innerHTML = html;
        }

        function updateHourlyChart(hourlyData) {
            const chartDiv = document.getElementById('hourlyChart');
            
            if (!hourlyData || Object.keys(hourlyData).length === 0) {
                chartDiv.innerHTML = `
                    <div class="empty-state">
                        <h3>⏰ No Hourly Data</h3>
                        <p>24-hour activity patterns will be shown here after collecting usage data.</p>
                    </div>
                `;
                return;
            }
            
            const maxValue = Math.max(...Object.values(hourlyData));
            
            let html = '<div style="display: flex; align-items: end; gap: 4px; height: 180px; padding: 20px 0;">';
            
            for (let hour = 0; hour < 24; hour++) {
                const count = hourlyData[hour] || 0;
                const height = maxValue > 0 ? (count / maxValue) * 140 : 0;
                
                html += `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                        <div style="background: linear-gradient(135deg, #4facfe, #00f2fe); 
                                    width: 100%; height: ${height}px; border-radius: 3px; 
                                    margin-bottom: 8px; min-height: 3px;
                                    ${count > 0 ? `title='${count} measurements at ${hour}:00'` : ''}
                                    box-shadow: 0 2px 8px rgba(79, 172, 254, 0.3);"></div>
                        <div style="font-size: 0.75em; color: #666; font-weight: 500;">${hour}</div>
                    </div>
                `;
            }
            
            html += '</div>';
            chartDiv.innerHTML = html;
        }

        function setDefaultReportDate() {
            const today = new Date().toISOString().split('T')[0];
            const reportDateElement = document.getElementById('reportDate');
            if (reportDateElement) {
                reportDateElement.value = today;
            }
        }

        function loadDailyReport() {
            const reportDateElement = document.getElementById('reportDate');
            const date = reportDateElement ? reportDateElement.value : new Date().toISOString().split('T')[0];
            const reportContent = document.getElementById('reportContent');
            
            if (reportContent) {
                reportContent.innerHTML = '<div style="text-align: center; padding: 40px;"><span class="loading-spinner"></span>Loading daily report...</div>';
            }
            
            fetch(`/api/daily_report?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    displayDailyReport(data);
                    loadMeasurementLogs(date);
                })
                .catch(err => {
                    if (reportContent) {
                        reportContent.innerHTML = `
                            <div class="empty-state">
                                <h3>❌ Error Loading Report</h3>
                                <p>Failed to load daily report: ${err.message}</p>
                                <p>Please try again or check your connection.</p>
                            </div>
                        `;
                    }
                    showToast(`Failed to load daily report: ${err.message}`, 'error', 'Report Error');
                });
        }

        function loadMeasurementLogs(date) {
            const logsDiv = document.getElementById('measurementLogs');
            if (logsDiv) {
                logsDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><span class="loading-spinner"></span>Loading measurement logs...</div>';
            }
            
            fetch(`/api/measurement_logs?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    displayMeasurementLogs(data);
                })
                .catch(err => {
                    if (logsDiv) {
                        logsDiv.innerHTML = `
                            <div class="empty-state">
                                <h3>❌ Error Loading Logs</h3>
                                <p>Failed to load measurement logs: ${err.message}</p>
                            </div>
                        `;
                    }
                });
        }

        function displayDailyReport(report) {
            const reportContent = document.getElementById('reportContent');
            if (!reportContent) return;
            
            if (report.error) {
                reportContent.innerHTML = `
                    <div class="empty-state">
                        <h3>❌ Report Error</h3>
                        <p>${report.error}</p>
                    </div>
                `;
                return;
            }
            
            if (!report.summary || report.summary.total_measurements === 0) {
                reportContent.innerHTML = `
                    <div class="empty-state">
                        <h3>📅 No Activity Recorded</h3>
                        <p><strong>Date:</strong> ${report.date || document.getElementById('reportDate')?.value}</p>
                        <p>No distance measurements were performed on this date.</p>
                        <p>Start the sensor to begin collecting data.</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="analytics-grid">
                    <div class="stat-card distance-card">
                        <h4>Total Measurements</h4>
                        <div class="stat-value">${report.summary.total_measurements}</div>
                        <div class="stat-label">Distance readings</div>
                    </div>
                    <div class="stat-card measurement-card">
                        <h4>Average Distance</h4>
                        <div class="stat-value">${report.summary.avg_distance} cm</div>
                        <div class="stat-label">Mean reading</div>
                    </div>
                    <div class="stat-card quality-card">
                        <h4>Min Distance</h4>
                        <div class="stat-value">${report.summary.min_distance} cm</div>
                        <div class="stat-label">Closest detection</div>
                    </div>
                    <div class="stat-card range-card">
                        <h4>Max Distance</h4>
                        <div class="stat-value">${report.summary.max_distance} cm</div>
                        <div class="stat-label">Farthest detection</div>
                    </div>
                </div>
            `;
            
            if (report.insights && report.insights.length > 0) {
                html += `
                    <div class="chart-container">
                        <h3 class="section-title">🔍 Daily Insights</h3>
                        <ul class="insights-list">
                            ${report.insights.map(insight => `<li>${insight}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (report.zone_distribution) {
                html += `
                    <div class="chart-container">
                        <h3 class="section-title">📊 Zone Distribution</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                `;
                
                Object.entries(report.zone_distribution).forEach(([zone, count]) => {
                    const total = Object.values(report.zone_distribution).reduce((a, b) => a + b, 0);
                    const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                    
                    html += `
                        <div class="distance-zone zone-${zone}" style="flex: 1; min-width: 120px; text-align: center; padding: 18px;">
                            <strong>${count}</strong><br>
                            ${formatZone(zone)}<br>
                            <small>(${percentage}%)</small>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            if (report.hourly_activity) {
                html += `
                    <div class="chart-container">
                        <h3 class="section-title">⏰ Hourly Activity</h3>
                        <div style="display: flex; align-items: end; gap: 4px; height: 180px; padding: 20px 0;">
                `;
                
                const maxValue = Math.max(...Object.values(report.hourly_activity));
                
                for (let hour = 0; hour < 24; hour++) {
                    const count = report.hourly_activity[hour] || 0;
                    const height = maxValue > 0 ? (count / maxValue) * 140 : 0;
                    
                    html += `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <div style="background: linear-gradient(135deg, #4facfe, #00f2fe); 
                                        width: 100%; height: ${height}px; border-radius: 3px; 
                                        margin-bottom: 8px; min-height: 3px;
                                        ${count > 0 ? `title='${count} measurements at ${hour}:00'` : ''}
                                        box-shadow: 0 2px 8px rgba(79, 172, 254, 0.3);"></div>
                            <div style="font-size: 0.75em; color: #666; font-weight: 500;">${hour}</div>
                        </div>
                    `;
                }
                
                html += '</div></div>';
            }
            
            reportContent.innerHTML = html;
        }

        function displayMeasurementLogs(data) {
            const logsDiv = document.getElementById('measurementLogs');
            if (!logsDiv) return;
            
            if (!data.logs || data.logs.length === 0) {
                logsDiv.innerHTML = `
                    <div class="empty-state">
                        <h3>📝 No Measurement Logs</h3>
                        <p>No distance measurement logs found for this date.</p>
                        <p>Start the sensor to begin collecting data.</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="max-height: 500px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 15px; padding: 20px; background: #fafafa;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); font-weight: 700;">
                                <th style="padding: 15px; text-align: left; border-bottom: 3px solid #dee2e6; border-radius: 8px 0 0 0;">Time</th>
                                <th style="padding: 15px; text-align: left; border-bottom: 3px solid #dee2e6;">Distance</th>
                                <th style="padding: 15px; text-align: left; border-bottom: 3px solid #dee2e6;">Zone</th>
                                <th style="padding: 15px; text-align: left; border-bottom: 3px solid #dee2e6; border-radius: 0 8px 0 0;">Quality</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.logs.forEach((log, index) => {
                const time = new Date(log.timestamp).toLocaleTimeString();
                const qualityColor = log.quality_score > 0.8 ? '#4caf50' : 
                                  log.quality_score > 0.6 ? '#8bc34a' : 
                                  log.quality_score > 0.4 ? '#ffc107' : '#f44336';
                
                const rowBg = index % 2 === 0 ? 'background: white;' : 'background: #f8f9fa;';
                
                html += `
                    <tr style="${rowBg} border-bottom: 1px solid #e9ecef; transition: all 0.3s ease;" 
                        onmouseover="this.style.background='#e3f2fd'" 
                        onmouseout="this.style.background='${index % 2 === 0 ? 'white' : '#f8f9fa'}'">
                        <td style="padding: 12px 15px; font-weight: 500;">${time}</td>
                        <td style="padding: 12px 15px; font-weight: 700; color: #333;">${log.distance} cm</td>
                        <td style="padding: 12px 15px;">
                            <span class="distance-zone zone-${log.zone}" style="font-size: 0.8em; padding: 4px 8px;">${formatZone(log.zone)}</span>
                        </td>
                        <td style="padding: 12px 15px;">
                            <span style="color: ${qualityColor}; font-weight: 700;">${(log.quality_score * 100).toFixed(1)}%</span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 10px; font-size: 1em; color: #495057;">
                    <strong>📊 Summary:</strong> ${data.logs.length} total logs • 
                    Avg distance: <span style="font-weight: 700; color: #4caf50;">${data.avg_distance} cm</span> • 
                    Avg quality: <span style="font-weight: 700; color: #2196f3;">${(data.avg_quality * 100).toFixed(1)}%</span>
                </div>
            `;
            
            logsDiv.innerHTML = html;
        }

        function formatZone(zone) {
            const zoneMap = {
                'very_close': 'Very Close',
                'close': 'Close',
                'medium': 'Medium',
                'far': 'Far',
                'very_far': 'Very Far'
            };
            return zoneMap[zone] || zone;
        }

        function initializeDashboard() {
            // Auto-start the sensor when the dashboard loads
            fetch('/api/health')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const statusEl = document.getElementById('status');
                    if (statusEl) {
                        if (data.sensor_active) {
                            statusEl.innerHTML = '🔍 Sensor Active';
                            statusEl.className = 'status success';
                            sensorActive = true;
                            measurementInterval = setInterval(getCurrentDistance, 500);
                            showToast('Distance sensor is already running', 'success', 'Sensor Active');
                        } else {
                            // Auto-start the sensor
                            autoStartSensor();
                        }
                    }
                    
                    console.log('Server features:', data.features || {});
                })
                .catch(err => {
                    console.error('Initial health check failed:', err);
                    const statusEl = document.getElementById('status');
                    if (statusEl) {
                        statusEl.innerHTML = '❌ Cannot connect to server';
                        statusEl.className = 'status error';
                    }
                    showToast('Cannot connect to distance sensor server', 'error', 'Connection Failed');
                });

            setDefaultReportDate();
        }

        function autoStartSensor() {
            if (!sensorActive) {
                sensorActive = true;
                document.getElementById('status').innerHTML = '<span class="loading-spinner"></span>Starting sensor...';
                document.getElementById('status').className = 'status warning';
                
                fetch('/api/sensor/start', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('status').innerHTML = '🔍 Sensor Active';
                            document.getElementById('status').className = 'status success';
                            measurementInterval = setInterval(getCurrentDistance, 500);
                            showToast('Distance sensor started automatically', 'success', 'Sensor Started');
                        } else {
                            document.getElementById('status').innerHTML = '❌ ' + data.message;
                            document.getElementById('status').className = 'status error';
                            sensorActive = false;
                            showToast(data.message, 'error', 'Auto-start Failed');
                        }
                    })
                    .catch(err => {
                        document.getElementById('status').innerHTML = '❌ Connection error';
                        document.getElementById('status').className = 'status error';
                        sensorActive = false;
                        showToast('Failed to auto-start sensor server', 'error', 'Connection Error');
                    });
            }
        }

        function startPeriodicUpdates() {
            setInterval(() => {
                fetch('/api/health')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const analyticsTab = document.getElementById('analytics-tab');
                        if (analyticsTab && analyticsTab.classList.contains('active')) {
                            if (data.current_distance !== undefined) {
                                const elements = {
                                    avgDistance: data.current_distance.toFixed(1) + ' cm',
                                    totalMeasurements: data.total_measurements
                                };
                                
                                Object.entries(elements).forEach(([id, value]) => {
                                    const element = document.getElementById(id);
                                    if (element) element.textContent = value;
                                });
                            }
                        }
                    })
                    .catch(err => {
                        console.error('Periodic health check error:', err);
                    });
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            startPeriodicUpdates();
        });
    </script>
</body>
</html>