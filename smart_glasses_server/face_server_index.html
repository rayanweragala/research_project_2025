<!DOCTYPE html>
<html>
<head>
    <title>Smart Glasses Face Recognition</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f0f0f0; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .camera-section { display: flex; gap: 20px; margin-bottom: 20px; }
        .video-container { flex: 1; }
        .controls { flex: 1; }
        #cameraFeed { width: 100%; max-width: 640px; border: 2px solid #ddd; border-radius: 10px; }
        .button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .start { background: #4CAF50; color: white; }
        .stop { background: #f44336; color: white; }
        .results { margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 5px; }
        .recognition-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .recognized { background: #d4edda; border: 1px solid #c3e6cb; }
        .unknown { background: #fff3cd; border: 1px solid #ffeaa7; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .stats { display: flex; gap: 20px; margin-top: 20px; }
        .stat-box { flex: 1; padding: 15px; background: #e9ecef; border-radius: 5px; text-align: center; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ì Smart Glasses Face Recognition</h1>
        <p>Using laptop camera to simulate smart glasses feed</p>
        
        <div class="camera-section">
            <div class="video-container">
                <img id="cameraFeed" alt="Camera feed will appear here" />
            </div>
            
            <div class="controls">
                <h3>Controls</h3>
                <button class="button start" onclick="startRecognition()">Start Recognition</button>
                <button class="button stop" onclick="stopRecognition()">Stop Recognition</button>
                
                <h3>System Status</h3>
                <div id="status" class="status">Ready</div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-box">
                <h4>Recognition Rate</h4>
                <div id="recognitionRate">0%</div>
            </div>
            <div class="stat-box">
                <h4>Avg Processing Time</h4>
                <div id="avgTime">0ms</div>
            </div>
            <div class="stat-box">
                <h4>Total Requests</h4>
                <div id="totalRequests">0</div>
            </div>
            <div class="stat-box">
                <h4>Error Rate</h4>
                <div id="errorRate">0%</div>
            </div>
        </div>
        
        <div class="results">
            <h3>Recognition Results</h3>
            <div id="results"></div>
        </div>
    </div>

    <script>
        let recognitionActive = false;
        let recognitionInterval;

        function startRecognition() {
            if (!recognitionActive) {
                recognitionActive = true;
                document.getElementById('status').innerHTML = 'üîç Starting camera...';
                document.getElementById('status').className = 'status warning';
                
                fetch('/api/camera/start', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('status').innerHTML = 'üîç Recognition Active';
                            document.getElementById('status').className = 'status success';
                            recognitionInterval = setInterval(getServerFrame, 1000);
                        } else {
                            document.getElementById('status').innerHTML = '‚ùå ' + data.message;
                            document.getElementById('status').className = 'status error';
                            recognitionActive = false;
                        }
                    })
                    .catch(err => {
                        document.getElementById('status').innerHTML = '‚ùå Connection error';
                        document.getElementById('status').className = 'status error';
                        recognitionActive = false;
                    });
            }
        }

        function stopRecognition() {
            recognitionActive = false;
            document.getElementById('status').innerHTML = '‚è∏Ô∏è Stopping camera...';
            
            if (recognitionInterval) {
                clearInterval(recognitionInterval);
            }
            
            fetch('/api/camera/stop', { method: 'POST' })
                .then(() => {
                    document.getElementById('status').innerHTML = '‚è∏Ô∏è Recognition Stopped';
                    document.getElementById('status').className = 'status warning';
                })
                .catch(() => {
                    document.getElementById('status').innerHTML = '‚è∏Ô∏è Recognition Stopped';
                    document.getElementById('status').className = 'status warning';
                });
        }

        function getServerFrame() {
            if (!recognitionActive) return;
            
            fetch('/api/camera/frame')
                .then(response => response.json())
                .then(data => {
                    if (data.image) {
                        document.getElementById('cameraFeed').src = 'data:image/jpeg;base64,' + data.image;
                        displayResult(data);
                    } else if (data.error) {
                        displayResult({
                            recognized: false,
                            name: null,
                            confidence: 0,
                            message: data.error,
                            quality_score: 0,
                            processing_time: 0,
                            error: true
                        });
                    }
                })
                .catch(err => {
                    console.error('Frame error:', err);
                    displayResult({
                        recognized: false,
                        name: null,
                        confidence: 0,
                        message: `Frame error: ${err.message}`,
                        quality_score: 0,
                        processing_time: 0,
                        error: true
                    });
                });
        }

        function displayResult(data) {
            let resultsDiv = document.getElementById('results');
            let resultClass = data.error ? 'error' : (data.recognized ? 'recognized' : 'unknown');
            
            let confidence = data.confidence || 0;
            let quality = data.quality_score || 0;
            let processingTime = data.processing_time || 0;
            
            let message = data.error ? 
                `‚ùå ${data.message}` :
                (data.recognized ? 
                    `‚úÖ ${data.name} (${(confidence * 100).toFixed(1)}% confidence)` :
                    `‚ùì ${data.message} (${(confidence * 100).toFixed(1)}% similarity)`);
            
            let modelStatus = data.model_loaded ? 'üü¢' : 'üî¥';
            
            let resultHtml = `
                <div class="recognition-result ${resultClass}">
                    <strong>${new Date().toLocaleTimeString()}</strong>: ${message}
                    <br><small>Quality: ${(quality * 100).toFixed(1)}%, 
                    Processing: ${(processingTime * 1000).toFixed(0)}ms, 
                    Model: ${modelStatus}</small>
                </div>
            `;
            
            resultsDiv.innerHTML = resultHtml + resultsDiv.innerHTML;
          
            let results = resultsDiv.children;
            while (results.length > 10) {
                resultsDiv.removeChild(results[results.length - 1]);
            }
        }

        setInterval(() => {
            fetch('/api/health')
                .then(response => response.json())
                .then(data => {
                    if (data.recognition_stats) {
                        let stats = data.recognition_stats;
                        let rate = stats.total_requests > 0 ? 
                            (stats.successful_recognitions / stats.total_requests * 100).toFixed(1) : 0;
                        let errorRate = stats.total_requests > 0 ?
                            (stats.errors / stats.total_requests * 100).toFixed(1) : 0;
                        
                        document.getElementById('recognitionRate').textContent = rate + '%';
                        document.getElementById('avgTime').textContent = (stats.avg_processing_time * 1000).toFixed(0) + 'ms';
                        document.getElementById('totalRequests').textContent = stats.total_requests;
                        document.getElementById('errorRate').textContent = errorRate + '%';
                        
                        if (!recognitionActive) {
                            let statusEl = document.getElementById('status');
                            if (!data.model_loaded) {
                                statusEl.innerHTML = '‚ö†Ô∏è Model not loaded - basic detection only';
                                statusEl.className = 'status warning';
                            }
                        }
                    }
                })
                .catch(err => console.error('Stats error:', err));
        }, 3000);
    </script>
</body>
</html>